# Задание 3. Переход на Event-Driven архитектуру

## Cписок проблем и рисков, которые связаны с планируемым ростом нагрузки

- ins-product-aggregator работает в синхронном режиме со сторонними API и зависит от них, при "подвисании" одного из сторонних API ответы остальных API не будут отданы в ответе, вместо этого произойдет таймаут.
- при увеличение сторонних api количество сбоев ins-comp-settlement будет неизбежно рости
- ins-comp-settlement раз в сутки создает большую нагрузку
- При изменении предложений СК ins-comp-settlement узнает об этом только при следующем обновлении, которое происходит раз в сутки - есть риск получить неконсистентные данные

## Решения

- добавить Circuit Breaker на подключение к каждому внешнему api, при этом в аггрегированной информации по предложениям необходимо добавить маркер недоступности СК.
Эти действия помогут избежать отображения/продажи неактуальных страховок.
- добавить очередь (kafka)
- ins-product-aggregator в качестве продьюсера будет создавать сообщения о событии обновления предложений СК, которые он будет получать по расписанию.
- ins-comp-settlement и core-app будут в качестве консьюмеров читать сообщения о событии обновления предложений СК и при наличии реальных изменений будут обновлять записи в своих БД.
- Потеря сообщения об обновлении предложений не является критичной, т.к. вызовет только не значительную задержку в предоставление данных, т.е. внедрение Transactional Outbox не имеет смысла, так же при перезапуске сервисов ins-comp-settlement или core-app будет возможность перечитать сообщения из kafka и восстановить актуальные предложения СК.
- Передача данных об оформелнных страховках из core-app в ins-comp-settlement критически важна(т.к. каждое такое событие непосредственно приносит прибыль компании).
Для того что бы гарантировать доставку таки сообщений используется CDC система Debezium, которая читает лог postgres core-db и генерирует сообщения о событие оформеление страховки в очередь kafka.
- ins-comp-settlement подписывается на сообщения об оформлении страховок и плавно накапливает данные в своей БД для суммарных отчетов.